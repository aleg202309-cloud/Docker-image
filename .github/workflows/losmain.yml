name: Empaquetar Fish Speech Definitivo
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar Imagen Base
        run: |
          # Usamos la imagen oficial v1.5 que es la m√°s estable
          docker pull fishaudio/fish-speech:latest-v1.5-gh
          docker tag fishaudio/fish-speech:latest-v1.5-gh fish-base:latest

      - name: Descargar Modelos (Checkpoints)
        run: |
          mkdir -p checkpoints/fish-speech-1.5
          cd checkpoints/fish-speech-1.5
          # Descargamos los pesos reales del cerebro de la IA
          curl -L -o model.pth https://huggingface.co/fishaudio/fish-speech-1.5/resolve/main/model.pth
          curl -L -o config.json https://huggingface.co/fishaudio/fish-speech-1.5/resolve/main/config.json
          curl -L -o vqgan.pth https://huggingface.co/fishaudio/fish-speech-1.5/resolve/main/firefly-gan-vq-fsq-8x1024-21hz-generator.pth

      - name: Inyectar Modelos en la Imagen
        run: |
          # Creamos un contenedor "molde"
          docker create --name temp-fish fish-base:latest
          # Metemos los archivos pesados dentro
          docker cp checkpoints temp-fish:/app/
          # Guardamos el resultado como una nueva imagen lista para usar
          docker commit temp-fish fish-speech-es:ready
          docker rm temp-fish

      - name: Exportar a TAR
        run: |
          docker save fish-speech-es:ready -o fish_speech_bundle.tar

      - name: Subir Artefacto
        uses: actions/upload-artifact@v4
        with:
          name: fish-speech-bundle
          path: fish_speech_bundle.tar
          retention-days: 1
